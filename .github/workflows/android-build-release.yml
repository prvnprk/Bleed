name: Android-Bleed-Build-Release

on:
  push:
    tags: ['v*']

jobs:
  build-and-release:
    runs-on: windows-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout source
      uses: actions/checkout@v4
    
    - name: Install Ninja
      run: |
        choco install ninja -y
        echo "C:\ProgramData\chocolatey\bin" | Out-File -FilePath $env:GITHUB_PATH -Append

    - name: Download Android NDK r27d
      run: |
        Invoke-WebRequest -Uri "https://dl.google.com/android/repository/android-ndk-r27d-windows.zip" -OutFile "ndk.zip"
        Expand-Archive ndk.zip -DestinationPath .
        Rename-Item -Path android-ndk-r27d -NewName android-ndk

    - name: Configure CMake
      run: |
        $NDK_PATH = "${{ github.workspace }}\android-ndk".Replace('\', '/')
        cmake -B build `
          -G "Ninja" `
          -DCMAKE_SYSTEM_NAME=Android `
          -DCMAKE_SYSTEM_VERSION=21 `
          -DCMAKE_ANDROID_ARCH_ABI=arm64-v8a `
          -DCMAKE_ANDROID_NDK="$NDK_PATH" `
          -DCMAKE_ANDROID_STL_TYPE=c++_static `
          -DCMAKE_BUILD_TYPE=Release `
          -DCMAKE_MAKE_PROGRAM="$(Get-Command ninja | Select-Object -ExpandProperty Source)"

    - name: Build
      run: cmake --build build --config Release

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: build/*.so
        body: "BLEED android ARM64 native libraries built from ${{ github.sha }}"
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
